name: Build MacOS
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Build Process
        env:
          CSC_LINK: ""
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: |
          # 1. Находим папку с проектом
          PACKAGE_PATH=$(find . -name "package.json" -not -path "*/node_modules/*" | head -n 1)
          PROJECT_DIR=$(dirname "$PACKAGE_PATH")
          cd "$PROJECT_DIR"
          
          echo "Рабочая директория: $PROJECT_DIR"
          
          # 2. Установка
          npm install

          # 3. Пытаемся собрать приложение разными способами
          # Сначала проверим, какие скрипты вообще есть
          cat package.json | grep scripts -A 10
          
          # Пробуем собрать
          npm run build --if-present
          npm run electron:build --if-present
          npm run pack --if-present
          npm run dist --if-present

          # 4. ДИАГНОСТИКА: Ищем все файлы .dmg и .zip по всему репозиторию
          echo "Поиск готовых файлов..."
          find . -name "*.dmg"
          find . -name "*.zip"
          
          # Выводим структуру папок для понимания, где мы
          ls -R

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mole-UI-Mac-Binary
          # Теперь мы используем максимально широкий поиск
          path: |
            **/*.dmg
            **/*.zip
            **/release/*.dmg
            **/dist/*.dmg
